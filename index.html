<script>
const MODO_GRABACION = false;
if(MODO_GRABACION) app.classList.add("grabacion");

let historial=[];

function haptic(){if(navigator.vibrate) navigator.vibrate(10);}
function bloquear(b){document.querySelectorAll(".pkg").forEach(p=>p.classList.toggle("disabled",b));}

// Objeto dinámico para guardar saldo de cualquier usuario
const USUARIOS={};

function validarUsuario(){
  const u = user.value.trim();
  haptic();

  // Regex para validar formato de usuario: @usuario con letras, números, puntos o guiones
  const formato = /^@[a-zA-Z0-9._-]{1,30}$/;
  if(!formato.test(u)){
    error.style.display="block"; suspend.style.display="none";
    avatar.innerText="U"; saldo.innerText="0"; hist.innerHTML="";
    bloquear(true); return;
  }

  error.style.display="none";
  suspend.style.display="none";
  avatar.innerText=u[1].toUpperCase(); // primera letra después de @

  // Inicializa saldo si es nuevo usuario
  if(!USUARIOS[u]) USUARIOS[u] = { saldo: 0 };

  saldo.innerText = USUARIOS[u].saldo;
  historial = []; 
  hist.innerHTML="";
  bloquear(false);
}

function confirmar(c){
  const u = user.value.trim();
  if(!u) return; // no hay usuario
  haptic();

  const o=document.createElement("div"); o.className="overlay";
  o.innerHTML=`<div class="modal">
    <div style="font-size:15px;margin-bottom:6px">Confirmar compra</div>
    <strong style="font-size:22px">${c} monedas</strong>
    <button class="confirm pulse" onclick="pagar('${u}',${c});o.remove()">Confirmar</button>
    <button class="cancel" onclick="o.remove()">Cancelar</button>
  </div>`;
  document.body.appendChild(o);
}

function pagar(u, c){
  haptic(); 
  const base = USUARIOS[u].saldo;
  saldo.innerText = "…";

  setTimeout(()=>{
    const nuevo = base + c;
    USUARIOS[u].saldo = nuevo;
    saldo.innerText = nuevo;

    // historial dinámico por usuario
    historial.unshift({c, t: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})});
    historial = historial.slice(0,5);
    hist.innerHTML = historial.map(h=>`<div class="item"><span>+${h.c}</span><span>${h.t}</span></div>`).join("");

    const ok = document.createElement("div"); ok.className="overlay";
    ok.innerHTML=`<div class="modal"><div class="check">✓</div><div>Pago confirmado</div></div>`;
    document.body.appendChild(ok); 
    setTimeout(()=>ok.remove(),1200);
  },700);
}

bloquear(true);
</script>
